#!/bin/bash

set -e  # Exit on error

# Configuration
PROJECT_TYPE_ML="python-ml"
PROJECT_TYPE_FASTAPI="python-fastapi"
PROJECT_TYPE_SCIENCE="python-science"
PROJECT_TYPE_VITE="vite-react"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Utility Functions
usage() {
    cat << EOF
Usage: dev <project-type> <directory> [flags]

Project Types:
  ${PROJECT_TYPE_ML}, ${PROJECT_TYPE_FASTAPI}, ${PROJECT_TYPE_SCIENCE}
  ${PROJECT_TYPE_VITE}

Flags:
  -g, --git           Initialize Git repository
  -v [uv|venv]        Create virtual environment (default: uv)
  -t, --tailwind      Add Tailwind CSS v4 (Vite projects only)
  -h, --help          Show this help
EOF
}

create_file() {
    echo -e "$2" > "$1"
}

log_info() {
    printf "${BLUE}→${NC} %s\n" "$1"
}

log_success() {
    printf "${GREEN}✓${NC} %s\n" "$1"
}

log_error() {
    printf "${RED}✗${NC} %s\n" "$1"
}

log_warn() {
    printf "${YELLOW}⚠${NC} %s\n" "$1"
}

# Python Project Creation
create_ml_project() {
    local target_dir=$1
    local project_name=$2
    log_info "Creating $PROJECT_TYPE_ML project structure..."
    mkdir -p "$target_dir"/{conf,data/{raw,processed},src/"$project_name",models,notebooks,tests}

    create_file "$target_dir/setup.cfg" "[metadata]
name = $project_name
version = 0.1.0
description = A machine learning project.

[options]
packages = find:
install_requires = file:requirements.txt
python_requires = >=3.9"

    create_file "$target_dir/requirements.txt" "numpy
pandas
scikit-learn
matplotlib
jupyter
PyYAML
loguru"

    create_file "$target_dir/conf/config.yaml" "data:
  raw_path: data/raw/input.csv
model:
  n_estimators: 100
  random_state: 42"

    create_file "$target_dir/src/$project_name/__init__.py" ""
    create_file "$target_dir/src/$project_name/data.py" "import pandas as pd

def load_data(path):
    return pd.read_csv(path)

def preprocess(df):
    return df.dropna()"

    create_file "$target_dir/Makefile" "train:
\tpython3 -m $project_name.main

clean:
\trm -rf models/* data/processed/*

.PHONY: train clean"

    create_file "$target_dir/README.md" "# ML Project: $project_name"
}

create_fastapi_project() {
    local target_dir=$1
    local project_name=$2
    log_info "Creating $PROJECT_TYPE_FASTAPI project structure..."
    mkdir -p "$target_dir"/app/{api/v1,core/config,db,models,schemas,tests}

    create_file "$target_dir/requirements.txt" "fastapi
uvicorn[standard]
pydantic
SQLAlchemy
python-multipart
httpx"

    create_file "$target_dir/app/main.py" "from fastapi import FastAPI
from app.api.v1.endpoints import router as v1_router

app = FastAPI(title='FastAPI Project')
app.include_router(v1_router, prefix='/api/v1')"

    create_file "$target_dir/app/api/v1/endpoints.py" "from fastapi import APIRouter

router = APIRouter()

@router.get('/')
async def root():
    return {'message': 'Welcome to API v1'}"

    create_file "$target_dir/Dockerfile" "FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
EXPOSE 8000
CMD [\"uvicorn\", \"app.main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]"

    create_file "$target_dir/pyproject.toml" "[tool.black]
line-length = 88

[tool.isort]
profile = \"black\""

    create_file "$target_dir/README.md" "# FastAPI Project: $project_name"
}

create_science_project() {
    local target_dir=$1
    local project_name=$2
    log_info "Creating $PROJECT_TYPE_SCIENCE project structure..."
    mkdir -p "$target_dir"/{data/{raw,processed},notebooks,src/"$project_name",reports/figures,environments}

    create_file "$target_dir/environments/analysis.yml" "name: $project_name-env
channels:
  - conda-forge
dependencies:
  - python=3.10
  - numpy
  - pandas
  - scipy
  - matplotlib
  - seaborn
  - jupyterlab"

    create_file "$target_dir/requirements.txt" "numpy
pandas
scipy
matplotlib
scikit-learn
statsmodels"

    create_file "$target_dir/src/$project_name/data_ingestion.py" "import pandas as pd

def fetch_data():
    print(\"Fetching data...\")
    df = pd.DataFrame({'A': [1,2,3]})
    df.to_csv('../data/raw/data.csv', index=False)
    print(\"Saved: data/raw/data.csv\")"

    create_file "$target_dir/README.md" "# Science Project: $project_name"
}

# Vite Project Creation
create_vite_project() {
    local target_dir=$1
    local with_tailwind=$2
    
    if ! command -v npm &> /dev/null; then
        log_error "Error: npm not found. Install Node.js first."
        exit 1
    fi
    
    log_info "Creating Vite React project..."
    npm create vite@latest "$target_dir" -- --template react --no-interactive > /dev/null 2>&1
    cd "$target_dir" || exit 1
    
    if [ "$with_tailwind" = true ]; then
        log_info "Installing Tailwind CSS v4..."
        npm install tailwindcss @tailwindcss/vite > /dev/null 2>&1
        
        create_file "vite.config.js" "import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'

export default defineConfig({
  plugins: [react(), tailwindcss()],
})"
        
        create_file "src/index.css" "@import \"tailwindcss\";"
        log_success "Tailwind CSS v4 configured!"
    else
        npm install > /dev/null 2>&1
    fi
}

# Main Script
[[ "$1" == "-h" || "$1" == "--help" ]] && { usage; exit 0; }
[ "$#" -lt 2 ] && { usage; exit 1; }

PROJECT_TYPE=$1
TARGET_DIR=$2
[ "$TARGET_DIR" == "." ] && PROJECT_NAME=$(basename "$PWD") || PROJECT_NAME=$(basename "$TARGET_DIR")

FLAG_GIT=false
FLAG_VENV=""
FLAG_TAILWIND=false

i=3
while [ $i -le $# ]; do
    arg="${!i}"
    case "$arg" in
        -g|--git) FLAG_GIT=true ;;
        -v)
            i=$((i + 1))
            next_arg="${!i}"
            if [ "$next_arg" = "venv" ]; then
                FLAG_VENV="venv"
            else
                FLAG_VENV="uv"
                i=$((i - 1))  # No argument provided, default to uv
            fi
            ;;
        -t|--tailwind) FLAG_TAILWIND=true ;;
        *) log_error "Unknown flag: $arg"; exit 1 ;;
    esac
    i=$((i + 1))
done

# Create project based on type
case "$PROJECT_TYPE" in
    $PROJECT_TYPE_VITE)
        [ "$TARGET_DIR" != "." ] && [ -d "$TARGET_DIR" ] && { log_error "Error: Directory '$TARGET_DIR' already exists."; exit 1; }
        create_vite_project "$TARGET_DIR" $FLAG_TAILWIND
        # Already cd'd inside create_vite_project
        ;;
    *)
        if [ "$TARGET_DIR" != "." ]; then
            [ -d "$TARGET_DIR" ] && { log_error "Error: Directory '$TARGET_DIR' already exists."; exit 1; }
            mkdir -p "$TARGET_DIR"
            log_success "Created: $TARGET_DIR"
        fi
        cd "$TARGET_DIR" || exit 1
        case "$PROJECT_TYPE" in
            $PROJECT_TYPE_ML) create_ml_project "." "$PROJECT_NAME" ;;
            $PROJECT_TYPE_FASTAPI) create_fastapi_project "." "$PROJECT_NAME" ;;
            $PROJECT_TYPE_SCIENCE) create_science_project "." "$PROJECT_NAME" ;;
            *) log_error "Unknown project type: $PROJECT_TYPE"; exit 1 ;;
        esac
        ;;
esac

# Handle flags
if $FLAG_GIT && command -v git &> /dev/null; then
    git init > /dev/null
    case "$PROJECT_TYPE" in
        $PROJECT_TYPE_VITE)
            create_file ".gitignore" "# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?"
            ;;
        *)
            create_file ".gitignore" "__pycache__
.venv
*.pyc
*.log
data/raw
models
reports/figures"
            ;;
    esac
    log_success "Git initialized."
fi

# Python virtual environment
case "$PROJECT_TYPE" in
    $PROJECT_TYPE_ML|$PROJECT_TYPE_FASTAPI|$PROJECT_TYPE_SCIENCE)
        if [ -n "$FLAG_VENV" ]; then
            if [ "$FLAG_VENV" = "venv" ]; then
                log_info "Creating venv with python..."
                python3 -m venv .venv > /dev/null && source .venv/bin/activate && pip install -r requirements.txt > /dev/null
            else
                if command -v uv &> /dev/null; then
                    log_info "Creating venv with uv..."
                    uv venv .venv > /dev/null && source .venv/bin/activate && uv pip install -r requirements.txt > /dev/null
                else
                    log_info "uv not found, falling back to python venv..."
                    python3 -m venv .venv > /dev/null && source .venv/bin/activate && pip install -r requirements.txt > /dev/null
                fi
            fi
            log_success "Virtual environment ready."
        fi
        ;;
esac

log_success "Done! Project created: $PROJECT_NAME"
[ "$PROJECT_TYPE" = "$PROJECT_TYPE_VITE" ] && log_info "Run 'cd $TARGET_DIR && npm run dev' to start."